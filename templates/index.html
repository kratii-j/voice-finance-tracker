{% extends "base.html" %}

{% block content %}
<section class="mb-4">
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">Today's Total</h5>
          <p class="display-6">₹{{ "%.2f"|format(total_today) }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">This Month</h5>
          <p class="display-6">₹{{ "%.2f"|format(monthly_total) }}</p>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="row g-3 mb-4">
  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title">Weekly Summary</h5>
        <pre class="mb-0">{{ weekly_summary }}</pre>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title">Monthly Summary</h5>
        <pre class="mb-0">{{ monthly_summary }}</pre>
      </div>
    </div>
  </div>
</section>

<section class="mb-4">
  <h4>Charts</h4>
  <div class="row g-3">
    {% if charts.category %}
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="card-title">Category Breakdown</h6>
          <img src="{{ url_for('static', filename=charts.category) }}" class="img-fluid rounded" alt="Category chart">
        </div>
      </div>
    </div>
    {% endif %}
    {% if charts.daily %}
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="card-title">Daily Spend (7 days)</h6>
          <img src="{{ url_for('static', filename=charts.daily) }}" class="img-fluid rounded" alt="Daily spend chart">
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</section>

<section class="mb-4">
  <h4>Category Totals</h4>
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-striped mb-0">
        <thead>
          <tr>
            <th>Category</th>
            <th>Total (₹)</th>
          </tr>
        </thead>
        <tbody>
          {% for category, total in category_totals %}
          <tr>
            <td>{{ category }}</td>
            <td>{{ "%.2f"|format(total) }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="2" class="text-center text-muted py-4">No data available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<section class="mb-4">
  <h4>Recent Expenses</h4>
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-striped mb-0">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Amount (₹)</th>
            <th>Category</th>
            <th>Description</th>
            <th>Payment</th>
          </tr>
        </thead>
        <tbody>
          {% for expense in recent_expenses %}
          <tr>
            <td>{{ expense.date }}</td>
            <td>{{ expense.time }}</td>
            <td>{{ "%.2f"|format(expense.amount) }}</td>
            <td>{{ expense.category }}</td>
            <td>{{ expense.description or "-" }}</td>
            <td>{{ expense.payment_method or "-" }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">No expenses recorded yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<section class="mb-5">
  <h4>Add a New Expense</h4>
  <form id="addExpenseForm" class="row g-3">
    <div class="col-md-4">
      <input type="number" step="0.01" class="form-control" id="amount" placeholder="Amount (₹)" required>
    </div>
    <div class="col-md-4">
      <input type="text" class="form-control" id="category" placeholder="Category (e.g. food)" required>
    </div>
    <div class="col-md-4">
      <button type="submit" class="btn btn-primary w-100">Add Expense</button>
    </div>
  </form>
  <div id="response" class="mt-3"></div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.getElementById("addExpenseForm").addEventListener("submit", async (event) => {
  event.preventDefault();
  const amount = parseFloat(document.getElementById("amount").value);
  const category = document.getElementById("category").value.trim();

  const res = await fetch("/api/add", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ amount, category }),
  });

  const data = await res.json();
  const output = document.getElementById("response");

  if (!res.ok || data.error) {
    output.innerHTML = `<div class="alert alert-danger">${data.error || "Failed to add expense."}</div>`;
    return;
  }

  output.innerHTML = `<div class="alert alert-success">${data.message}<br>
    Today's total: ₹${data.total_today.toFixed(2)}<br>
    This month: ₹${data.monthly_total.toFixed(2)}</div>`;

  document.getElementById("amount").value = "";
  document.getElementById("category").value = "";
});
</script>
{% endblock %}
